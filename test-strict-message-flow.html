<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸¥æ ¼æ¶ˆæ¯æµç¨‹æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .flow-description {
            background-color: #e7f3ff;
            border: 1px solid #bee3f8;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .flow-title {
            color: #2b6cb0;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .step-flow {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        .step {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            position: relative;
        }
        
        .step.user {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .step.storage {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
        }
        
        .step.ai {
            background-color: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        
        .step.complete {
            background-color: #e8f5e8;
            border-left: 4px solid #4caf50;
        }
        
        .step-number {
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .step.storage .step-number {
            background-color: #ff9800;
        }
        
        .step.ai .step-number {
            background-color: #9c27b0;
        }
        
        .step.complete .step-number {
            background-color: #4caf50;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .step-description {
            font-size: 14px;
            color: #666;
        }
        
        .arrow {
            text-align: center;
            color: #007bff;
            font-size: 20px;
            margin: 5px 0;
        }
        
        .benefits {
            background-color: #f0fff4;
            border: 1px solid #c6f6d5;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .benefits h3 {
            color: #38a169;
            margin-top: 0;
        }
        
        .benefit-item {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        
        .benefit-item::before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #38a169;
            font-weight: bold;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .comparison-item {
            padding: 15px;
            border-radius: 8px;
        }
        
        .old-flow {
            background-color: #fff5f5;
            border: 1px solid #fed7d7;
        }
        
        .new-flow {
            background-color: #f0fff4;
            border: 1px solid #c6f6d5;
        }
        
        .comparison-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .old-flow .comparison-title {
            color: #c53030;
        }
        
        .new-flow .comparison-title {
            color: #38a169;
        }
        
        .code-example {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
            margin: 20px 0;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #e0e0e0;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #007bff;
            border: 2px solid white;
        }
        
        .timeline-item.storage::before {
            background-color: #ff9800;
        }
        
        .timeline-item.ai::before {
            background-color: #9c27b0;
        }
        
        .timeline-item.complete::before {
            background-color: #4caf50;
        }
        
        .timeline-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .timeline-content {
            font-size: 14px;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-waiting {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-processing {
            background-color: #cce5ff;
            color: #0066cc;
        }
        
        .status-complete {
            background-color: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ ä¸¥æ ¼æ¶ˆæ¯æµç¨‹è®¾è®¡</h1>
            <p>ç¡®ä¿æ¯ä¸ªæ­¥éª¤å®Œæˆåæ‰è¿›è¡Œä¸‹ä¸€æ­¥çš„èŠå¤©ä½“éªŒ</p>
        </div>

        <!-- æµç¨‹æè¿° -->
        <div class="flow-description">
            <div class="flow-title">ğŸ“‹ æ–°çš„ä¸¥æ ¼æµç¨‹</div>
            <p>ä¸ºäº†ç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œç”¨æˆ·ä½“éªŒçš„å¯é¢„æµ‹æ€§ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªä¸¥æ ¼çš„æ­¥éª¤åŒ–æµç¨‹ï¼Œæ¯ä¸ªæ­¥éª¤å¿…é¡»å®Œæˆåæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥ã€‚</p>
        </div>

        <!-- è¯¦ç»†æ­¥éª¤æµç¨‹ -->
        <div class="container">
            <h3>ğŸ”¢ è¯¦ç»†æ­¥éª¤æµç¨‹</h3>
            
            <div class="step-flow">
                <div class="step user">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-title">ç”¨æˆ·å‘é€æ¶ˆæ¯</div>
                        <div class="step-description">ç”¨æˆ·è¾“å…¥æ¶ˆæ¯å¹¶ç‚¹å‡»å‘é€ï¼Œæ¶ˆæ¯ç«‹å³æ¸²æŸ“åœ¨èŠå¤©ç•Œé¢ä¸­</div>
                    </div>
                </div>
                
                <div class="arrow">â†“</div>
                
                <div class="step storage">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-title">ä¸Šä¼ ç”¨æˆ·æ¶ˆæ¯åˆ°æ•°æ®åº“</div>
                        <div class="step-description">æ˜¾ç¤º"ğŸ’¾ æ­£åœ¨ä¿å­˜æ‚¨çš„æ¶ˆæ¯..."ï¼Œç­‰å¾…æ•°æ®åº“å­˜å‚¨å®Œæˆ</div>
                    </div>
                </div>
                
                <div class="arrow">â†“</div>
                
                <div class="step ai">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <div class="step-title">AIå¼€å§‹å“åº”</div>
                        <div class="step-description">ç”¨æˆ·æ¶ˆæ¯ä¿å­˜æˆåŠŸåï¼ŒAIå¼€å§‹ç”Ÿæˆå›å¤ï¼Œæ˜¾ç¤º"æ­£åœ¨æ€è€ƒä¸­..."</div>
                    </div>
                </div>
                
                <div class="arrow">â†“</div>
                
                <div class="step ai">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <div class="step-title">å®æ—¶æ¸²æŸ“AIå›å¤</div>
                        <div class="step-description">AIæµå¼å›å¤è¿‡ç¨‹ä¸­ï¼Œå®æ—¶æ›´æ–°AIæ¶ˆæ¯æ°”æ³¡å†…å®¹</div>
                    </div>
                </div>
                
                <div class="arrow">â†“</div>
                
                <div class="step storage">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <div class="step-title">ä¸Šä¼ AIæ¶ˆæ¯åˆ°æ•°æ®åº“</div>
                        <div class="step-description">AIå›å¤å®Œæˆåï¼Œæ˜¾ç¤º"ğŸ’¾ æ­£åœ¨ä¿å­˜AIå›å¤..."ï¼Œç­‰å¾…æ•°æ®åº“å­˜å‚¨å®Œæˆ</div>
                    </div>
                </div>
                
                <div class="arrow">â†“</div>
                
                <div class="step complete">
                    <div class="step-number">6</div>
                    <div class="step-content">
                        <div class="step-title">ç”¨æˆ·å¯ä»¥ç»§ç»­èŠå¤©</div>
                        <div class="step-description">AIæ¶ˆæ¯ä¿å­˜æˆåŠŸåï¼Œç§»é™¤å­˜å‚¨æç¤ºï¼Œç”¨æˆ·å¯ä»¥å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¶é—´çº¿æ¼”ç¤º -->
        <div class="container">
            <h3>â±ï¸ äº¤äº’æ—¶é—´çº¿</h3>
            
            <div class="timeline">
                <div class="timeline-item">
                    <div class="timeline-time">T0: ç”¨æˆ·æ“ä½œ</div>
                    <div class="timeline-content">
                        ç”¨æˆ·è¾“å…¥"ä½ å¥½"å¹¶ç‚¹å‡»å‘é€
                        <span class="status-indicator status-complete">ç«‹å³å®Œæˆ</span>
                    </div>
                </div>
                
                <div class="timeline-item storage">
                    <div class="timeline-time">T1: å­˜å‚¨ç”¨æˆ·æ¶ˆæ¯</div>
                    <div class="timeline-content">
                        æ˜¾ç¤º"ğŸ’¾ æ­£åœ¨ä¿å­˜æ‚¨çš„æ¶ˆæ¯..."ï¼Œè°ƒç”¨ /api/messages/create
                        <span class="status-indicator status-processing">ç­‰å¾…å®Œæˆ</span>
                    </div>
                </div>
                
                <div class="timeline-item ai">
                    <div class="timeline-time">T2: AIå¼€å§‹å“åº”</div>
                    <div class="timeline-content">
                        ç”¨æˆ·æ¶ˆæ¯ä¿å­˜æˆåŠŸï¼Œæ˜¾ç¤º"æ­£åœ¨æ€è€ƒä¸­..."ï¼Œè°ƒç”¨ /api/chat/stream
                        <span class="status-indicator status-processing">å¼€å§‹å¤„ç†</span>
                    </div>
                </div>
                
                <div class="timeline-item ai">
                    <div class="timeline-time">T3-T5: AIæµå¼å›å¤</div>
                    <div class="timeline-content">
                        AIå®æ—¶ç”Ÿæˆå›å¤å†…å®¹ï¼Œç”¨æˆ·çœ‹åˆ°é€å­—æ˜¾ç¤ºçš„å›å¤
                        <span class="status-indicator status-processing">å®æ—¶æ›´æ–°</span>
                    </div>
                </div>
                
                <div class="timeline-item storage">
                    <div class="timeline-time">T6: å­˜å‚¨AIæ¶ˆæ¯</div>
                    <div class="timeline-content">
                        AIå›å¤å®Œæˆï¼Œæ˜¾ç¤º"ğŸ’¾ æ­£åœ¨ä¿å­˜AIå›å¤..."ï¼Œè°ƒç”¨ /api/messages/create
                        <span class="status-indicator status-processing">ç­‰å¾…å®Œæˆ</span>
                    </div>
                </div>
                
                <div class="timeline-item complete">
                    <div class="timeline-time">T7: å®Œæˆ</div>
                    <div class="timeline-content">
                        AIæ¶ˆæ¯ä¿å­˜æˆåŠŸï¼Œç§»é™¤å­˜å‚¨æç¤ºï¼Œç”¨æˆ·å¯ä»¥ç»§ç»­èŠå¤©
                        <span class="status-indicator status-complete">å¯ä»¥ç»§ç»­</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- å…³é”®å®ç°ä»£ç  -->
        <div class="container">
            <h3>ğŸ’» å…³é”®å®ç°ä»£ç </h3>
            
            <h4>1. ç”¨æˆ·æ¶ˆæ¯å­˜å‚¨</h4>
            <div class="code-example">
// æ­¥éª¤2: ä¸Šä¼ ç”¨æˆ·æ¶ˆæ¯åˆ°æ•°æ®åº“
setIsStoringMessages(true);
onUpdate({ content: "ğŸ’¾ æ­£åœ¨ä¿å­˜æ‚¨çš„æ¶ˆæ¯...", role: "assistant" });

const userStorageSuccess = await storeMessage(
  currentSessionId,
  "user",
  message.content,
  { stage: "user_input", timestamp: Date.now() }
);

if (!userStorageSuccess) {
  setIsStoringMessages(false);
  onError(new Error("ç”¨æˆ·æ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•"));
  return;
}
            </div>
            
            <h4>2. AIå“åº”å¤„ç†</h4>
            <div class="code-example">
// æ­¥éª¤3: ç”¨æˆ·æ¶ˆæ¯ä¿å­˜æˆåŠŸï¼Œå¼€å§‹AIå“åº”
onUpdate({ content: "æ­£åœ¨æ€è€ƒä¸­...", role: "assistant" });

// è°ƒç”¨AIæµå¼API
const response = await fetch("/api/chat/stream", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    Authorization: `Bearer ${token}`,
  },
  body: JSON.stringify({
    session_id: currentSessionId,
    query: message.content,
  }),
});
            </div>
            
            <h4>3. AIæ¶ˆæ¯å­˜å‚¨</h4>
            <div class="code-example">
if (data.finished) {
  // æ­¥éª¤6: AIå›å¤å®Œæˆï¼Œä¸Šä¼ AIæ¶ˆæ¯åˆ°æ•°æ®åº“
  onUpdate({ 
    content: fullContent + "\n\nğŸ’¾ æ­£åœ¨ä¿å­˜AIå›å¤...", 
    role: "assistant" 
  });

  const aiStorageSuccess = await storeMessage(
    currentSessionId,
    "assistant",
    fullContent,
    finalWorkflowState || { stage: "ai_response", timestamp: Date.now() }
  );

  if (aiStorageSuccess) {
    // æ­¥éª¤7: AIæ¶ˆæ¯ä¿å­˜æˆåŠŸï¼Œç§»é™¤å­˜å‚¨æç¤º
    onUpdate({ content: fullContent, role: "assistant" });
    console.log("å¯¹è¯å®Œæˆï¼Œç”¨æˆ·å¯ä»¥ç»§ç»­èŠå¤©");
  }

  // é‡ç½®å­˜å‚¨çŠ¶æ€ï¼Œå…è®¸ç”¨æˆ·ç»§ç»­èŠå¤©
  setIsStoringMessages(false);
}
            </div>
        </div>

        <!-- æµç¨‹å¯¹æ¯” -->
        <div class="comparison">
            <div class="comparison-item old-flow">
                <div class="comparison-title">âŒ æ—§æµç¨‹ï¼ˆæ‰¹é‡å­˜å‚¨ï¼‰</div>
                <ul>
                    <li>ç”¨æˆ·å‘é€æ¶ˆæ¯ â†’ ç«‹å³æ˜¾ç¤º</li>
                    <li>AIå®æ—¶å›å¤</li>
                    <li>å›å¤å®Œæˆåæ‰¹é‡å­˜å‚¨ç”¨æˆ·+AIæ¶ˆæ¯</li>
                    <li>å­˜å‚¨æœŸé—´ç”¨æˆ·æ— æ³•ç»§ç»­èŠå¤©</li>
                    <li>å­˜å‚¨å¤±è´¥å½±å“æ•´ä¸ªå¯¹è¯</li>
                </ul>
            </div>
            
            <div class="comparison-item new-flow">
                <div class="comparison-title">âœ… æ–°æµç¨‹ï¼ˆä¸¥æ ¼æ­¥éª¤ï¼‰</div>
                <ul>
                    <li>ç”¨æˆ·å‘é€æ¶ˆæ¯ â†’ ç«‹å³æ˜¾ç¤º</li>
                    <li>å…ˆå­˜å‚¨ç”¨æˆ·æ¶ˆæ¯ â†’ æˆåŠŸåAIæ‰å“åº”</li>
                    <li>AIå®æ—¶å›å¤</li>
                    <li>AIå®Œæˆåç«‹å³å­˜å‚¨AIæ¶ˆæ¯</li>
                    <li>å­˜å‚¨å®Œæˆåç”¨æˆ·æ‰èƒ½ç»§ç»­</li>
                </ul>
            </div>
        </div>

        <!-- ä¼˜åŠ¿å’Œç‰¹ç‚¹ -->
        <div class="benefits">
            <h3>ğŸ¯ ä¸¥æ ¼æµç¨‹çš„ä¼˜åŠ¿</h3>
            <div class="benefit-item">æ•°æ®ä¸€è‡´æ€§ï¼šç¡®ä¿æ¯æ¡æ¶ˆæ¯éƒ½è¢«æ­£ç¡®å­˜å‚¨</div>
            <div class="benefit-item">é”™è¯¯å¤„ç†ï¼šä»»ä½•æ­¥éª¤å¤±è´¥éƒ½ä¼šé˜»æ­¢åç»­æ“ä½œ</div>
            <div class="benefit-item">ç”¨æˆ·åé¦ˆï¼šæ¯ä¸ªæ­¥éª¤éƒ½æœ‰æ˜ç¡®çš„çŠ¶æ€æç¤º</div>
            <div class="benefit-item">é˜²æ­¢å†²çªï¼šç”¨æˆ·å¿…é¡»ç­‰å¾…å½“å‰å¯¹è¯å®Œæˆæ‰èƒ½ç»§ç»­</div>
            <div class="benefit-item">å¯é¢„æµ‹æ€§ï¼šç”¨æˆ·æ¸…æ¥šçŸ¥é“ç³»ç»Ÿæ­£åœ¨åšä»€ä¹ˆ</div>
            <div class="benefit-item">è°ƒè¯•å‹å¥½ï¼šæ¯ä¸ªæ­¥éª¤éƒ½å¯ä»¥ç‹¬ç«‹ç›‘æ§å’Œè°ƒè¯•</div>
        </div>

        <!-- æ³¨æ„äº‹é¡¹ -->
        <div class="flow-description">
            <div class="flow-title">âš ï¸ æ³¨æ„äº‹é¡¹</div>
            <ul>
                <li><strong>ç½‘ç»œå»¶è¿Ÿ</strong>ï¼šæ¯ä¸ªå­˜å‚¨æ­¥éª¤éƒ½éœ€è¦ç½‘ç»œè¯·æ±‚ï¼Œå¯èƒ½å¢åŠ æ€»ä½“å“åº”æ—¶é—´</li>
                <li><strong>ç”¨æˆ·ç­‰å¾…</strong>ï¼šç”¨æˆ·éœ€è¦ç­‰å¾…å­˜å‚¨å®Œæˆæ‰èƒ½ç»§ç»­ï¼Œå¯èƒ½å½±å“æµç•…æ€§</li>
                <li><strong>é”™è¯¯æ¢å¤</strong>ï¼šä»»ä½•æ­¥éª¤å¤±è´¥éƒ½ä¼šä¸­æ–­æ•´ä¸ªæµç¨‹ï¼Œéœ€è¦ç”¨æˆ·é‡è¯•</li>
                <li><strong>çŠ¶æ€ç®¡ç†</strong>ï¼šéœ€è¦ç²¾ç¡®ç®¡ç† isStoringMessages çŠ¶æ€ï¼Œé¿å…çŠ¶æ€ä¸ä¸€è‡´</li>
            </ul>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ­¥éª¤è¿›åº¦åŠ¨ç”»
        function animateSteps() {
            const steps = document.querySelectorAll('.step');
            
            steps.forEach((step, index) => {
                setTimeout(() => {
                    step.style.transform = 'scale(1.02)';
                    step.style.boxShadow = '0 4px 12px rgba(0,123,255,0.3)';
                    
                    setTimeout(() => {
                        step.style.transform = 'scale(1)';
                        step.style.boxShadow = 'none';
                    }, 300);
                }, index * 800);
            });
        }

        // é¡µé¢åŠ è½½åå¼€å§‹åŠ¨ç”»
        window.addEventListener('load', () => {
            setTimeout(animateSteps, 1000);
            setInterval(animateSteps, 8000); // æ¯8ç§’é‡å¤ä¸€æ¬¡
        });
    </script>
</body>
</html>