<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸¥æ ¼æ¶ˆæ¯æµç¨‹æµ‹è¯• - å¢å¼ºç‰ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #1677ff;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .flow-diagram {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 12px 0;
            padding: 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .step.active {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            transform: translateX(5px);
        }
        
        .step.completed {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
        }
        
        .step.error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
        }
        
        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #1677ff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .step.completed .step-number {
            background: #52c41a;
        }
        
        .step.error .step-number {
            background: #ff4d4f;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .step-description {
            font-size: 14px;
            color: #666;
        }
        
        .step-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 12px;
        }
        
        .status-waiting {
            background: #f0f0f0;
            color: #666;
        }
        
        .status-processing {
            background: #e6f7ff;
            color: #1677ff;
        }
        
        .status-completed {
            background: #f6ffed;
            color: #52c41a;
        }
        
        .status-error {
            background: #fff2f0;
            color: #ff4d4f;
        }
        
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            background: #1677ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 10px;
            transition: background 0.3s ease;
        }
        
        .btn:hover {
            background: #4096ff;
        }
        
        .btn:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
        
        .btn.danger {
            background: #ff4d4f;
        }
        
        .btn.danger:hover {
            background: #ff7875;
        }
        
        .timeline {
            margin: 20px 0;
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
            border-left: 4px solid #1677ff;
        }
        
        .timeline-item {
            margin: 8px 0;
            font-size: 14px;
            color: #666;
        }
        
        .timeline-time {
            color: #1677ff;
            font-weight: 500;
        }
        
        .message-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .message-bubble {
            background: white;
            border-radius: 12px;
            padding: 12px 16px;
            margin: 8px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .message-bubble.user {
            background: #1677ff;
            color: white;
            margin-left: 60px;
        }
        
        .message-bubble.assistant {
            background: white;
            margin-right: 60px;
        }
        
        .loading-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1677ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .strict-notice {
            background: #fff7e6;
            border: 1px solid #ffd591;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }
        
        .strict-notice h3 {
            color: #d46b08;
            margin: 0 0 8px 0;
        }
        
        .strict-notice p {
            margin: 4px 0;
            color: #8c4a00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”’ ä¸¥æ ¼æ¶ˆæ¯æµç¨‹æµ‹è¯•</h1>
        
        <div class="strict-notice">
            <h3>âš ï¸ ä¸¥æ ¼æµç¨‹è¯´æ˜</h3>
            <p>â€¢ ç”¨æˆ·æ¶ˆæ¯å¿…é¡»å®Œå…¨ä¸Šä¼ åˆ°æ•°æ®åº“åï¼ŒAIæ‰èƒ½å¼€å§‹å“åº”</p>
            <p>â€¢ AIå“åº”å¿…é¡»å®Œå…¨ä¸Šä¼ åˆ°æ•°æ®åº“åï¼Œç”¨æˆ·æ‰èƒ½ç»§ç»­èŠå¤©</p>
            <p>â€¢ ä»»ä½•æ­¥éª¤å¤±è´¥éƒ½ä¼šé˜»æ­¢åç»­æ“ä½œ</p>
            <p>â€¢ æ¯ä¸ªæ­¥éª¤éƒ½æœ‰æ˜ç¡®çš„çŠ¶æ€åé¦ˆ</p>
        </div>
        
        <div class="flow-diagram">
            <h3>ğŸ“‹ æ¶ˆæ¯æµç¨‹æ­¥éª¤</h3>
            
            <div class="step" id="step-1">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="step-title">ç”¨æˆ·å‘é€æ¶ˆæ¯</div>
                    <div class="step-description">ç«‹å³æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡</div>
                </div>
                <div class="step-status status-waiting">ç­‰å¾…ä¸­</div>
            </div>
            
            <div class="step" id="step-2">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="step-title">ä¸Šä¼ ç”¨æˆ·æ¶ˆæ¯</div>
                    <div class="step-description">ä¸¥æ ¼ç­‰å¾…ç”¨æˆ·æ¶ˆæ¯ä¸Šä¼ åˆ°æ•°æ®åº“å®Œæˆ</div>
                </div>
                <div class="step-status status-waiting">ç­‰å¾…ä¸­</div>
            </div>
            
            <div class="step" id="step-3">
                <div class="step-number">3</div>
                <div class="step-content">
                    <div class="step-title">AIå¼€å§‹å“åº”</div>
                    <div class="step-description">ç”¨æˆ·æ¶ˆæ¯ä¿å­˜æˆåŠŸåï¼ŒAIæ‰å¼€å§‹å“åº”</div>
                </div>
                <div class="step-status status-waiting">ç­‰å¾…ä¸­</div>
            </div>
            
            <div class="step" id="step-4">
                <div class="step-number">4</div>
                <div class="step-content">
                    <div class="step-title">å®æ—¶æ¸²æŸ“AIå›å¤</div>
                    <div class="step-description">ç«‹å³æ¸²æŸ“AIæ¶ˆæ¯æ°”æ³¡ï¼Œæµå¼æ˜¾ç¤ºå†…å®¹</div>
                </div>
                <div class="step-status status-waiting">ç­‰å¾…ä¸­</div>
            </div>
            
            <div class="step" id="step-5">
                <div class="step-number">5</div>
                <div class="step-content">
                    <div class="step-title">ä¸Šä¼ AIæ¶ˆæ¯</div>
                    <div class="step-description">AIå“åº”å®Œæˆåï¼Œä¸¥æ ¼ç­‰å¾…AIæ¶ˆæ¯ä¸Šä¼ åˆ°æ•°æ®åº“</div>
                </div>
                <div class="step-status status-waiting">ç­‰å¾…ä¸­</div>
            </div>
            
            <div class="step" id="step-6">
                <div class="step-number">6</div>
                <div class="step-content">
                    <div class="step-title">ç”¨æˆ·å¯ä»¥ç»§ç»­èŠå¤©</div>
                    <div class="step-description">æ‰€æœ‰å­˜å‚¨æ“ä½œå®Œæˆåï¼Œé‡ç½®çŠ¶æ€å…è®¸ç”¨æˆ·ç»§ç»­</div>
                </div>
                <div class="step-status status-waiting">ç­‰å¾…ä¸­</div>
            </div>
        </div>
        
        <div class="message-preview">
            <h3>ğŸ’¬ æ¶ˆæ¯é¢„è§ˆ</h3>
            <div id="message-container">
                <div class="message-bubble assistant">
                    <em>ç­‰å¾…ç”¨æˆ·å‘é€æ¶ˆæ¯...</em>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" id="start-test" onclick="startStrictTest()">
                å¼€å§‹ä¸¥æ ¼æµç¨‹æµ‹è¯•
            </button>
            <button class="btn" id="simulate-error" onclick="simulateError()" disabled>
                æ¨¡æ‹Ÿå­˜å‚¨å¤±è´¥
            </button>
            <button class="btn danger" onclick="resetTest()">
                é‡ç½®æµ‹è¯•
            </button>
        </div>
        
        <div class="timeline" id="timeline">
            <h3>â±ï¸ æ‰§è¡Œæ—¶é—´çº¿</h3>
            <div id="timeline-content">
                <div class="timeline-item">ç­‰å¾…å¼€å§‹æµ‹è¯•...</div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        let startTime = Date.now();
        let isStoringMessages = false;
        let simulateStorageError = false;
        
        function addTimelineItem(message) {
            const timeline = document.getElementById('timeline-content');
            const elapsed = Date.now() - startTime;
            const item = document.createElement('div');
            item.className = 'timeline-item';
            item.innerHTML = `<span class="timeline-time">[${elapsed}ms]</span> ${message}`;
            timeline.appendChild(item);
            timeline.scrollTop = timeline.scrollHeight;
        }
        
        function updateStep(stepNum, status, statusText) {
            const step = document.getElementById(`step-${stepNum}`);
            const statusEl = step.querySelector('.step-status');
            
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            step.classList.remove('active', 'completed', 'error');
            statusEl.classList.remove('status-waiting', 'status-processing', 'status-completed', 'status-error');
            
            // æ·»åŠ æ–°çŠ¶æ€
            step.classList.add(status);
            statusEl.classList.add(`status-${status}`);
            statusEl.textContent = statusText;
            
            if (status === 'processing') {
                statusEl.innerHTML = '<div class="loading-indicator"></div>' + statusText;
            }
        }
        
        function addMessage(role, content) {
            const container = document.getElementById('message-container');
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${role}`;
            bubble.textContent = content;
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        }
        
        function updateMessage(content) {
            const container = document.getElementById('message-container');
            const lastBubble = container.lastElementChild;
            if (lastBubble && lastBubble.classList.contains('assistant')) {
                lastBubble.textContent = content;
            }
        }
        
        async function simulateStoreMessage(role, content) {
            addTimelineItem(`å¼€å§‹å­˜å‚¨${role === 'user' ? 'ç”¨æˆ·' : 'AI'}æ¶ˆæ¯åˆ°æ•°æ®åº“...`);
            
            // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 400));
            
            if (simulateStorageError && role === 'user') {
                addTimelineItem(`âŒ ${role === 'user' ? 'ç”¨æˆ·' : 'AI'}æ¶ˆæ¯å­˜å‚¨å¤±è´¥`);
                throw new Error('å­˜å‚¨å¤±è´¥');
            }
            
            addTimelineItem(`âœ… ${role === 'user' ? 'ç”¨æˆ·' : 'AI'}æ¶ˆæ¯å­˜å‚¨æˆåŠŸ`);
            return true;
        }
        
        async function simulateAIResponse() {
            addTimelineItem('ğŸ¤– AIå¼€å§‹ç”Ÿæˆå“åº”...');
            
            const responses = [
                "ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ã€‚",
                "ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®åŠ©ä½ è§£ç­”é—®é¢˜ã€‚",
                "ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®åŠ©ä½ è§£ç­”é—®é¢˜ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥ä¸ºä½ åšçš„å—ï¼Ÿ"
            ];
            
            // æ¨¡æ‹Ÿæµå¼å“åº”
            for (let i = 0; i < responses.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 300));
                updateMessage(responses[i]);
                addTimelineItem(`ğŸ“ AIå“åº”æ›´æ–°: ${responses[i].length} å­—ç¬¦`);
            }
            
            addTimelineItem('âœ… AIå“åº”å®Œæˆ');
            return responses[responses.length - 1];
        }
        
        async function startStrictTest() {
            const startBtn = document.getElementById('start-test');
            const errorBtn = document.getElementById('simulate-error');
            
            startBtn.disabled = true;
            errorBtn.disabled = false;
            isStoringMessages = true;
            startTime = Date.now();
            
            // æ¸…ç©ºæ—¶é—´çº¿
            document.getElementById('timeline-content').innerHTML = '';
            document.getElementById('message-container').innerHTML = '';
            
            addTimelineItem('ğŸš€ å¼€å§‹ä¸¥æ ¼æ¶ˆæ¯æµç¨‹æµ‹è¯•');
            
            try {
                // æ­¥éª¤1: ç”¨æˆ·å‘é€æ¶ˆæ¯ - ç«‹å³æ¸²æŸ“
                addTimelineItem('ğŸ‘¤ ç”¨æˆ·å‘é€æ¶ˆæ¯: "ä½ å¥½"');
                updateStep(1, 'active', 'å¤„ç†ä¸­');
                addMessage('user', 'ä½ å¥½');
                await new Promise(resolve => setTimeout(resolve, 100));
                updateStep(1, 'completed', 'å·²å®Œæˆ');
                addTimelineItem('âœ… ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡ç«‹å³æ¸²æŸ“å®Œæˆ');
                
                // æ­¥éª¤2: ä¸¥æ ¼ç­‰å¾…ç”¨æˆ·æ¶ˆæ¯ä¸Šä¼ å®Œæˆ
                updateStep(2, 'active', 'ä¸Šä¼ ä¸­');
                addMessage('assistant', 'ğŸ’¾ æ­£åœ¨ä¿å­˜æ‚¨çš„æ¶ˆæ¯...');
                
                try {
                    await simulateStoreMessage('user', 'ä½ å¥½');
                    updateStep(2, 'completed', 'å·²å®Œæˆ');
                    addTimelineItem('âœ… ç”¨æˆ·æ¶ˆæ¯ä¸Šä¼ å®Œæˆï¼ŒAIå¯ä»¥å¼€å§‹å“åº”');
                } catch (error) {
                    updateStep(2, 'error', 'å¤±è´¥');
                    updateMessage('âŒ ç”¨æˆ·æ¶ˆæ¯ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                    addTimelineItem('âŒ æµç¨‹å› ç”¨æˆ·æ¶ˆæ¯å­˜å‚¨å¤±è´¥è€Œç»ˆæ­¢');
                    throw error;
                }
                
                // æ­¥éª¤3: AIå¼€å§‹å“åº”
                updateStep(3, 'active', 'å¯åŠ¨ä¸­');
                updateMessage('æ­£åœ¨æ€è€ƒä¸­...');
                await new Promise(resolve => setTimeout(resolve, 200));
                updateStep(3, 'completed', 'å·²å®Œæˆ');
                addTimelineItem('ğŸ¤– AIå“åº”å·²å¯åŠ¨');
                
                // æ­¥éª¤4: å®æ—¶æ¸²æŸ“AIå›å¤
                updateStep(4, 'active', 'å“åº”ä¸­');
                const aiResponse = await simulateAIResponse();
                updateStep(4, 'completed', 'å·²å®Œæˆ');
                
                // æ­¥éª¤5: ä¸¥æ ¼ç­‰å¾…AIæ¶ˆæ¯ä¸Šä¼ å®Œæˆ
                updateStep(5, 'active', 'ä¸Šä¼ ä¸­');
                updateMessage(aiResponse + '\n\nğŸ’¾ æ­£åœ¨ä¿å­˜AIå›å¤...');
                
                try {
                    await simulateStoreMessage('assistant', aiResponse);
                    updateStep(5, 'completed', 'å·²å®Œæˆ');
                    updateMessage(aiResponse);
                    addTimelineItem('âœ… AIæ¶ˆæ¯ä¸Šä¼ å®Œæˆ');
                } catch (error) {
                    updateStep(5, 'error', 'å¤±è´¥');
                    updateMessage(aiResponse + '\n\nâš ï¸ AIå›å¤ä¿å­˜å¤±è´¥');
                    addTimelineItem('âš ï¸ AIæ¶ˆæ¯å­˜å‚¨å¤±è´¥ï¼Œä½†ä¸é˜»æ­¢ç”¨æˆ·ç»§ç»­');
                }
                
                // æ­¥éª¤6: ç”¨æˆ·å¯ä»¥ç»§ç»­èŠå¤©
                updateStep(6, 'active', 'é‡ç½®ä¸­');
                await new Promise(resolve => setTimeout(resolve, 300));
                updateStep(6, 'completed', 'å·²å®Œæˆ');
                isStoringMessages = false;
                
                addTimelineItem('ğŸ‰ ä¸¥æ ¼æ¶ˆæ¯æµç¨‹å®Œæˆï¼Œç”¨æˆ·ç°åœ¨å¯ä»¥ç»§ç»­èŠå¤©');
                
                const totalTime = Date.now() - startTime;
                addTimelineItem(`â±ï¸ æ€»è€—æ—¶: ${totalTime}ms`);
                
            } catch (error) {
                isStoringMessages = false;
                addTimelineItem(`ğŸ’¥ æµç¨‹å¼‚å¸¸ç»ˆæ­¢: ${error.message}`);
            } finally {
                startBtn.disabled = false;
                errorBtn.disabled = true;
                simulateStorageError = false;
            }
        }
        
        function simulateError() {
            simulateStorageError = true;
            document.getElementById('simulate-error').textContent = 'å·²å¯ç”¨é”™è¯¯æ¨¡æ‹Ÿ';
            addTimelineItem('âš ï¸ å·²å¯ç”¨å­˜å‚¨é”™è¯¯æ¨¡æ‹Ÿ');
        }
        
        function resetTest() {
            // é‡ç½®æ‰€æœ‰æ­¥éª¤
            for (let i = 1; i <= 6; i++) {
                updateStep(i, 'waiting', 'ç­‰å¾…ä¸­');
            }
            
            // æ¸…ç©ºå†…å®¹
            document.getElementById('timeline-content').innerHTML = 
                '<div class="timeline-item">ç­‰å¾…å¼€å§‹æµ‹è¯•...</div>';
            document.getElementById('message-container').innerHTML = 
                '<div class="message-bubble assistant"><em>ç­‰å¾…ç”¨æˆ·å‘é€æ¶ˆæ¯...</em></div>';
            
            // é‡ç½®çŠ¶æ€
            isStoringMessages = false;
            simulateStorageError = false;
            document.getElementById('start-test').disabled = false;
            document.getElementById('simulate-error').disabled = true;
            document.getElementById('simulate-error').textContent = 'æ¨¡æ‹Ÿå­˜å‚¨å¤±è´¥';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addTimelineItem('ğŸ“‹ ä¸¥æ ¼æ¶ˆæ¯æµç¨‹æµ‹è¯•é¡µé¢å·²åŠ è½½');
            addTimelineItem('â„¹ï¸ ç‚¹å‡»"å¼€å§‹ä¸¥æ ¼æµç¨‹æµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>