<!DOCTYPE html>
<html>
<head>
    <title>Modal修复测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Modal修复测试</h1>
    
    <div class="section info">
        <h3>修复说明</h3>
        <p>修复了Modal.confirm不显示的问题：</p>
        <ul>
            <li>在app/layout.tsx中添加了Ant Design的App组件包装器</li>
            <li>在page.tsx中使用App.useApp()获取modal实例</li>
            <li>将Modal.confirm改为modal.confirm</li>
        </ul>
    </div>
    
    <div class="section">
        <h3>测试步骤</h3>
        <ol>
            <li>确保应用已重新启动（因为修改了layout.tsx）</li>
            <li>访问主应用: <a href="http://localhost:3000" target="_blank">http://localhost:3000</a></li>
            <li>确保已登录并有会话数据</li>
            <li>右键点击任意会话项</li>
            <li>点击"Delete"菜单项</li>
            <li>应该看到删除确认对话框</li>
            <li>点击"Rename"菜单项</li>
            <li>应该看到重命名输入对话框</li>
        </ol>
    </div>
    
    <div class="section">
        <h3>预期行为</h3>
        <ul>
            <li>✅ 控制台显示: <code>🎯 菜单点击:</code></li>
            <li>✅ 控制台显示: <code>🗑️ 处理删除会话:</code></li>
            <li>✅ 显示删除确认对话框</li>
            <li>✅ 控制台显示: <code>🔄 处理重命名会话:</code></li>
            <li>✅ 显示重命名输入对话框</li>
        </ul>
    </div>
    
    <div class="section">
        <h3>快速准备</h3>
        <button onclick="quickSetup()">快速设置（登录+创建会话）</button>
        <div id="setup-result"></div>
    </div>
    
    <div class="section">
        <h3>故障排除</h3>
        <p>如果对话框仍然不显示：</p>
        <ul>
            <li>检查浏览器控制台是否有JavaScript错误</li>
            <li>确保应用已重新启动</li>
            <li>尝试硬刷新页面 (Ctrl+F5)</li>
            <li>检查是否有其他Modal或弹窗阻挡</li>
        </ul>
    </div>

    <script>
        async function quickSetup() {
            document.getElementById('setup-result').innerHTML = '<div class="info">正在设置...</div>';
            
            try {
                // 1. 登录
                const loginResponse = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'test@example.com', password: '123456' })
                });
                
                const loginData = await loginResponse.json();
                if (!loginData.success) {
                    throw new Error('登录失败: ' + loginData.message);
                }
                
                localStorage.setItem('auth_token', loginData.data.token);
                localStorage.setItem('user_info', JSON.stringify(loginData.data.user));
                
                // 2. 创建测试会话
                const sessionResponse = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${loginData.data.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: 'Modal测试会话 ' + new Date().toLocaleTimeString() })
                });
                
                const sessionData = await sessionResponse.json();
                if (!sessionData.success) {
                    throw new Error('创建会话失败: ' + sessionData.message);
                }
                
                document.getElementById('setup-result').innerHTML = 
                    '<div class="success">✅ 设置完成！<br>' +
                    '已登录用户: ' + loginData.data.user.email + '<br>' +
                    '已创建会话: ' + sessionData.data.title + '<br><br>' +
                    '<strong>下一步:</strong><br>' +
                    '1. 访问 <a href="http://localhost:3000" target="_blank">主应用</a><br>' +
                    '2. 右键点击会话项<br>' +
                    '3. 测试删除和重命名功能</div>';
                
            } catch (error) {
                document.getElementById('setup-result').innerHTML = 
                    '<div class="error">❌ 设置失败: ' + error.message + '</div>';
            }
        }
        
        // 页面加载时检查认证状态
        window.onload = function() {
            const token = localStorage.getItem('auth_token');
            if (token) {
                document.getElementById('setup-result').innerHTML = 
                    '<div class="success">✅ 用户已登录，可以直接测试</div>';
            }
        };
    </script>
</body>
</html>